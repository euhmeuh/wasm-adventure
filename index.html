<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>WebAssembly</title>
        <style type="text/css">
          #screen-canvas {
            border: solid 1px black;
            display: block;
          }
          .centered {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
          }
        </style>
    </head>
    <body>
        <canvas id="screen-canvas" class="centered" width="256" height="256">
          Please use a browser that supports canvas.
        </canvas>
        <script type="text/javascript">
            function fetchAndInstantiate(url, importObject) {
              return fetch(url).then(response =>
                response.arrayBuffer()
              ).then(bytes =>
                WebAssembly.instantiate(bytes, importObject)
              ).then(results =>
                results.instance
              );
            }
        </script>
        <script type="text/javascript">
          let canvas = document.getElementById('screen-canvas');
          if (canvas.getContext) {
            init();
          }

          function init() {
            let width = canvas.width;
            let height = canvas.height;
            let screenDataOffset = 1024;
            let ctx = canvas.getContext('2d');
            let instance;
            let imageData;
            let memory;
            let importObject = {
              console: {
                log: function(offset, length) {
                  var bytes = new Uint8Array(memory.buffer, offset, length);
                  var string = new TextDecoder('utf8').decode(bytes);
                  console.log(string);
                }
              }
            };
            
            fetchAndInstantiate('game.wasm', importObject)
              .then((inst) => instance = inst)
              .then(() => game())
              .catch((err) => {
                console.log(err);
              });

            function game() {
              instance.exports.init(width, height);
              memory = instance.exports.memory;
              imageData = new ImageData(new Uint8ClampedArray(memory.buffer, screenDataOffset, width*height*4), width, height)

              instance.exports.hello();

              let time = 0;
              setInterval(() => {
                instance.exports.render(time);
                ctx.putImageData(imageData, 0, 0);
                time += 1;
              }, 16); // ~60fps
            }
          }
        </script>
    </body>
</html>
